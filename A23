import React, { useState, useMemo, useEffect } from 'react';
import { DataGrid, GridToolbarContainer, gridClasses } from '@mui/x-data-grid';
import { 
  TextField, Box, Typography, Paper, Collapse, Stack, 
  Button, Divider, Dialog, DialogTitle, DialogContent, IconButton, alpha 
} from '@mui/material';

// Import existing project utility for file downloads
import downloadFile from '../utils/DownloadUtils'; 

// Icons
import FileDownloadIcon from '@mui/icons-material/FileDownload';
import RestartAltIcon from '@mui/icons-material/RestartAlt';
import HistoryIcon from '@mui/icons-material/History';
import CloseIcon from '@mui/icons-material/Close';
import EventAvailableIcon from '@mui/icons-material/EventAvailable';
import DateRangeIcon from '@mui/icons-material/DateRange';

export default function BalanceCompareDifferenceScreen() {
  const [activeTab, setActiveTab] = useState(null); 
  const [rows, setRows] = useState([]); // Data from API should be set here
  const [glcc, setGlcc] = useState('');
  const [date1, setDate1] = useState('');
  const [date2, setDate2] = useState('');
  const [openPopup, setOpenPopup] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  // Define Columns based on Manager's specific naming requirements
  const columns = useMemo(() => [
    { field: 'FIRST_ERROR_DATE', headerName: 'First Error Date', flex: 1, minWidth: 150 },
    { field: 'REPORT_DATE', headerName: 'Report_DATE', flex: 1, minWidth: 130 },
    { 
      field: 'GLCC', 
      headerName: 'GLCC', 
      flex: 1.5,
      minWidth: 220,
      // Fix for "Cannot read properties of undefined (reading 'row')"
      // In newer MUI X versions, valueGetter uses (value, row) instead of params
      valueGetter: (v, row) => {
        const target = row || v?.row; // Fallback for cross-version compatibility
        return target ? `${target.BRANCH_CODE}${target.CURRENCY}${target.CGL}` : "";
      }
    },
    { field: 'CBS_BALANCE', headerName: 'CBS_BALANCE', flex: 1, align: 'right' },
    { field: 'GL_BALANCE', headerName: 'GL_BALANCE', flex: 1, align: 'right' },
    { 
      field: 'DIFFERENCE_AMOUNT', 
      headerName: 'DIFFERENCE_AMOUNT', 
      flex: 1, 
      align: 'right' 
      // Removed conditional colors as per Manager's instruction
    },
    { field: 'DIFF_YESTERDAY', headerName: 'DIFFERence Between YESTERDAY', flex: 1.2, align: 'right' },
    { field: 'TYPE', headerName: 'TYPE', flex: 1 },
    { field: 'HEAD', headerName: 'HEAD', flex: 1 },
    {
      field: 'actions',
      headerName: 'History',
      flex: 1,
      minWidth: 130,
      renderCell: (params) => {
        // Show History button only if it's NOT a 'New Entry'
        if (params.row.TYPE !== 'New Entry') {
          return (
            <Button 
              variant="text" 
              size="small"
              startIcon={<HistoryIcon />}
              onClick={() => { setSelectedRow(params.row); setOpenPopup(true); }}
              sx={{ fontWeight: 700 }}
            >
              Details
            </Button>
          );
        }
        return null;
      }
    }
  ], []);

  // Handle Excel download using the project's existing utility
  const handleDownload = () => {
    // CSV is replaced by Excel as per requirement
    downloadFile(JSON.stringify(rows), 'xlsx', 'Reconciliation_Report', false);
  };

  const resetFilters = () => {
    setGlcc(''); setDate1(''); setDate2('');
    setActiveTab(null);
  };

  return (
    <Box sx={{ p: 4, bgcolor: '#f8fafc', minHeight: '100vh' }}>
      {/* Search Selection Section */}
      <Stack direction="row" spacing={2} sx={{ mb: 4 }}>
        <Button 
          variant={activeTab === 'particular' ? "contained" : "outlined"} 
          onClick={() => setActiveTab(activeTab === 'particular' ? null : 'particular')}
          startIcon={<EventAvailableIcon />}
          sx={{ flex: 1, borderRadius: '12px', fontWeight: 800 }}
        >
          Particular Date
        </Button>
        <Button 
          variant={activeTab === 'current' ? "contained" : "outlined"} 
          color="success"
          onClick={() => setActiveTab(activeTab === 'current' ? null : 'current')}
          startIcon={<HistoryIcon />}
          sx={{ flex: 1, borderRadius: '12px', fontWeight: 800 }}
        >
          Current Difference
        </Button>
        <Button 
          variant={activeTab === 'range' ? "contained" : "outlined"} 
          color="primary"
          onClick={() => setActiveTab(activeTab === 'range' ? null : 'range')}
          startIcon={<DateRangeIcon />}
          sx={{ flex: 1, borderRadius: '12px', fontWeight: 800 }}
        >
          Search Range
        </Button>
      </Stack>

      {/* Auto-Search Panel (updates table on input change) */}
      <Collapse in={activeTab !== null}>
        <Paper elevation={0} sx={{ p: 3, mb: 4, borderRadius: '16px', border: '1px solid #e2e8f0' }}>
          <Stack direction="row" spacing={3} alignItems="center">
            {(activeTab === 'current' || activeTab === 'range') && (
              <TextField label="GLCC" variant="filled" size="small" sx={{ width: 250 }} value={glcc} onChange={(e) => setGlcc(e.target.value)} />
            )}
            <TextField type="date" label="Report Date" variant="filled" size="small" InputLabelProps={{ shrink: true }} value={date1} onChange={(e) => setDate1(e.target.value)} sx={{ width: 180 }} />
            {activeTab === 'range' && (
              <TextField type="date" label="End Date" variant="filled" size="small" InputLabelProps={{ shrink: true }} value={date2} onChange={(e) => setDate2(e.target.value)} sx={{ width: 180 }} />
            )}
            <Divider orientation="vertical" flexItem />
            <Button variant="outlined" color="error" startIcon={<RestartAltIcon />} onClick={resetFilters}>Reset</Button>
            <Button variant="contained" startIcon={<FileDownloadIcon />} onClick={handleDownload} sx={{ bgcolor: '#1e293b' }}>
              Excel Download
            </Button>
          </Stack>
        </Paper>
      </Collapse>

      {/* Professional DataGrid Layout */}
      <Paper elevation={0} sx={{ borderRadius: '16px', border: '1px solid #e2e8f0', overflow: 'hidden' }}>
        <Box sx={{ height: 650, width: '100%' }}>
          <DataGrid 
            rows={rows} 
            columns={columns} 
            pageSizeOptions={[10, 20]}
            initialState={{ pagination: { paginationModel: { pageSize: 10 } } }}
            sx={{ 
              border: 0, 
              [`& .${gridClasses.columnHeader}`]: { bgcolor: '#f8fafc', fontWeight: 800, textTransform: 'uppercase', fontSize: '0.75rem' }
            }}
          />
        </Box>
      </Paper>

      {/* History Popup for Difference Details */}
      <Dialog open={openPopup} onClose={() => setOpenPopup(false)} maxWidth="sm" fullWidth PaperProps={{ sx: { borderRadius: '16px' } }}>
        <DialogTitle sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <Typography variant="h6" sx={{ fontWeight: 800 }}>Difference Details (History)</Typography>
          <IconButton onClick={() => setOpenPopup(false)}><CloseIcon /></IconButton>
        </DialogTitle>
        <DialogContent dividers>
          {selectedRow ? (
            <Stack spacing={2}>
              <Typography><strong>GLCC Entity:</strong> {`${selectedRow.BRANCH_CODE}${selectedRow.CURRENCY}${selectedRow.CGL}`}</Typography>
              <Typography variant="body2" color="textSecondary">
                Historical records indicate variances identified since the first error date. CBS journal entry verification is required.
              </Typography>
            </Stack>
          ) : (
            <Typography>No history available for this record.</Typography>
          )}
        </DialogContent>
      </Dialog>
    </Box>
  );
}
