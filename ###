import React, { useState, useMemo, useEffect, useCallback } from 'react';
import callApi from '../../utils/apiCaller'; 
import { DataGrid, gridClasses } from '@mui/x-data-grid';
import { 
  Box, Paper, Stack, Button, TextField, Divider,
  Dialog, DialogTitle, DialogContent, IconButton, Grid, Collapse, CircularProgress, Typography
} from '@mui/material';

import downloadFile from '../../utils/DownloadUtils'; 
import FileDownloadIcon from '@mui/icons-material/FileDownload';
import HistoryIcon from '@mui/icons-material/History';
import RestartAltIcon from '@mui/icons-material/RestartAlt';

export default function BalanceCompareDifferenceScreen() {
  const [activeTab, setActiveTab] = useState('particular'); 
  const [rows, setRows] = useState([]); 
  const [loading, setLoading] = useState(false);
  const [glcc, setGlcc] = useState('');
  const [date1, setDate1] = useState(''); 
  const [date2, setDate2] = useState(''); 
  const [systemEtlDate, setSystemEtlDate] = useState(''); 
  const [openPopup, setOpenPopup] = useState(false);
  const [selectedRow, setSelectedRow] = useState(null);

  // --- 1. SEPARATE CALL: Fetch ETL Date ONLY ONCE on Landing ---
  useEffect(() => {
    const getInitialDate = async () => {
      try {
        const res = await callApi('/PS/api/fincore-date', {}, "GET");
        if (res?.data?.success) {
          const etlDate = res.data.data.etlDate;
          setSystemEtlDate(etlDate);
          setDate1(etlDate); // Set the default date
        }
      } catch (err) { console.error("Initial Date Load Failed", err); }
    };
    getInitialDate();
  }, []); // Empty dependency ensures this runs ONLY ONCE.

  // --- 2. MAIN FETCH: Only calls Differences API ---
  const fetchDifferences = useCallback(async () => {
    // Prevent call if no date is present (except for 'current' tab which might be global)
    if (!date1 && activeTab !== 'current') return;

    setLoading(true);
    try {
      const response = await callApi('/RS/differences', {
          params: { page: 0, size: 10, reportDate: date1, endDate: date2, glccFilter: glcc }
      }, "GET");

      const content = response?.data?.content || response?.content || [];

      if (Array.isArray(content)) {
        const mappedRows = content.map((item, index) => ({
          ...item,
          id: index + 1,
          FIRST_ERROR_DATE: '', // Empty as per requirement
          REPORT_DATE: item.reconRunDate || '', // reconRunDate mapped here
          GLCC_VAL: `${item.branchCode || ''}${item.currency || ''}${item.cgl || ''}`,
          CBS_BALANCE: item.cbsBalance || 0,
          GL_BALANCE: item.glBalance || 0,
          DIFFERENCE_AMOUNT: item.differenceAmount || 0,
          DIFF_YESTERDAY: item.diffBwYesterday || 0
        }));
        setRows(mappedRows);
      } else { setRows([]); }
    } catch (err) {
      console.error("Data Fetch Error", err);
      setRows([]);
    } finally { setLoading(false); }
  }, [date1, date2, glcc, activeTab]);

  // --- 3. TRIGGER: Trigger Differences call when inputs change ---
  useEffect(() => {
    fetchDifferences();
  }, [fetchDifferences]);

  const handleTabClick = (tab) => {
    if (activeTab === tab) {
      setActiveTab(null);
    } else {
      setActiveTab(tab);
      setGlcc(''); setDate2('');
      // Reset date1 to system date only for 'particular' tab
      if (tab === 'particular') setDate1(systemEtlDate); 
      else setDate1('');
    }
  };

  const columns = useMemo(() => [
    { field: 'FIRST_ERROR_DATE', headerName: 'First Error Date', flex: 1 },
    { field: 'REPORT_DATE', headerName: 'Report_DATE', flex: 1 },
    { field: 'GLCC_VAL', headerName: 'GLCC', flex: 1.5 }, 
    { field: 'CBS_BALANCE', headerName: 'CBS_BALANCE', flex: 1, align: 'right' },
    { field: 'GL_BALANCE', headerName: 'GL_BALANCE', flex: 1, align: 'right' },
    { field: 'DIFFERENCE_AMOUNT', headerName: 'DIFFERENCE_AMOUNT', flex: 1, align: 'right' },
    { field: 'DIFF_YESTERDAY', headerName: 'DIFFerence Between YESTERDAY', flex: 1.2, align: 'right' },
    { field: 'type', headerName: 'TYPE', flex: 1 },
    { field: 'head', headerName: 'HEAD', flex: 1 },
    {
      field: 'actions', headerName: 'Details', width: 80, sortable: false,
      renderCell: (params) => (
        params.row?.type !== 'New Entry' && (
          <IconButton size="small" color="primary" onClick={() => { setSelectedRow(params.row); setOpenPopup(true); }}>
            <HistoryIcon fontSize="small" />
          </IconButton>
        )
      )
    }
  ], []);

  return (
    <Box sx={{ p: 3, bgcolor: '#f4f7f9', minHeight: '100vh' }}>
      <Stack direction="row" spacing={2} sx={{ mb: 3 }}>
        {['particular', 'current', 'range'].map((tab) => (
          <Button 
            key={tab} variant={activeTab === tab ? "contained" : "outlined"} onClick={() => handleTabClick(tab)}
            sx={{ flex: 1, textTransform: 'none', borderRadius: '12px', fontWeight: 700, py: 1.5 }}
          >
            {tab.charAt(0).toUpperCase() + tab.slice(1)} Date
          </Button>
        ))}
      </Stack>

      <Collapse in={activeTab !== null}>
        <Paper elevation={0} sx={{ p: 3, mb: 3, borderRadius: '12px', border: '1px solid #e0e4e8', bgcolor: '#fff' }}>
          <Stack direction="row" spacing={3} alignItems="center">
            {(activeTab === 'current' || activeTab === 'range') && (
              <TextField label="GLCC Filter" size="small" sx={{ width: 220 }} value={glcc} onChange={(e) => setGlcc(e.target.value)} />
            )}
            <TextField 
                type="date" label={activeTab === 'range' ? "Start Date" : "Report Date"} 
                size="small" InputLabelProps={{ shrink: true }} value={date1} onChange={(e) => setDate1(e.target.value)} 
            />
            {activeTab === 'range' && (
              <TextField 
                type="date" label="End Date" size="small" InputLabelProps={{ shrink: true }} value={date2} onChange={(e) => setDate2(e.target.value)} 
              />
            )}
            <Divider orientation="vertical" flexItem />
            <Button variant="outlined" color="error" startIcon={<RestartAltIcon />} onClick={() => {setGlcc(''); setDate1(systemEtlDate); setDate2('');}}>Reset</Button>
            <Button variant="contained" startIcon={<FileDownloadIcon />} onClick={() => downloadFile(JSON.stringify(rows), 'xlsx', 'Report')} sx={{ bgcolor: '#1e293b' }}>
              Export Excel
            </Button>
          </Stack>
        </Paper>
      </Collapse>

      <Paper elevation={0} sx={{ borderRadius: '12px', border: '1px solid #e0e4e8', overflow: 'hidden', position: 'relative' }}>
        {loading && <Box sx={{ position: 'absolute', top: '50%', left: '50%', zIndex: 10 }}><CircularProgress /></Box>}
        <Box sx={{ height: 600, width: '100%', opacity: loading ? 0.5 : 1 }}>
          <DataGrid 
            rows={rows} columns={columns} 
            pageSizeOptions={[10, 25, 50]}
            initialState={{ pagination: { paginationModel: { pageSize: 10 } } }}
            getRowId={(row) => row.id}
            sx={{ border: 0, [`& .${gridClasses.columnHeader}`]: { bgcolor: '#f8f9fa', fontWeight: 700 } }}
          />
        </Box>
      </Paper>

      <Dialog open={openPopup} onClose={() => setOpenPopup(false)} maxWidth="sm" fullWidth>
         <DialogTitle sx={{ fontWeight: 800 }}>Difference Details</DialogTitle>
         <DialogContent dividers sx={{ p: 3 }}>
            {selectedRow && (
              <Grid container spacing={2}>
                 <Grid item xs={6}><Typography variant="caption">GLCC</Typography><Typography sx={{ fontWeight: 600 }}>{selectedRow.GLCC_VAL}</Typography></Grid>
                 <Grid item xs={6}><Typography variant="caption">REPORT DATE</Typography><Typography>{selectedRow.REPORT_DATE}</Typography></Grid>
                 <Grid item xs={12}><Typography variant="h6" color="error">Difference: {selectedRow.DIFFERENCE_AMOUNT.toLocaleString()}</Typography></Grid>
              </Grid>
            )}
         </DialogContent>
      </Dialog>
    </Box>
  );
}
